import streamlit as st
from openai import OpenAI
from fpdf import FPDF
import pandas as pd
import io
import datetime
import re
import os
from dotenv import load_dotenv

# ç’°å¢ƒå¤‰æ•°ã‹ã‚‰APIã‚­ãƒ¼ã‚’èª­ã¿è¾¼ã‚€
load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=api_key)

# ç”¨é€”åœ°åŸŸãƒ«ãƒ¼ãƒ«
zone_rules = {
    "ç¬¬ä¸€ç¨®ä½å±¤ä½å±…å°‚ç”¨åœ°åŸŸ": "å»ºãºã„ç‡30ã€œ60%ã€å®¹ç©ç‡50ã€œ100%ã€é«˜ã•åˆ¶é™10mã¾ãŸã¯12mã€æ—¥å½±è¦åˆ¶ã‚ã‚Šã€ä½å±…å°‚ç”¨",
    "ç¬¬äºŒç¨®ä½å±¤ä½å±…å°‚ç”¨åœ°åŸŸ": "ç¬¬ä¸€ç¨®ã¨åŒæ§˜ã ãŒã€å°è¦æ¨¡åº—èˆ—ãƒ»äº‹å‹™æ‰€ã‚‚å¯",
    "ç¬¬ä¸€ç¨®ä¸­é«˜å±¤ä½å±…å°‚ç”¨åœ°åŸŸ": "ä½å±…ã‚’ä¸­å¿ƒã€å…±åŒä½å®…å¯ã€å­¦æ ¡ãƒ»ç—…é™¢ãªã©ã‚‚å¯ã€æ—¥å½±åˆ¶é™ã‚ã‚Š",
    "ç¬¬äºŒç¨®ä¸­é«˜å±¤ä½å±…å°‚ç”¨åœ°åŸŸ": "ç¬¬ä¸€ç¨®ã‚ˆã‚Šã‚„ã‚„ç”¨é€”ãŒåºƒãã€åº—èˆ—ã‚‚ã‚ã‚‹ç¨‹åº¦å¯",
    "ç¬¬ä¸€ç¨®ä½å±…åœ°åŸŸ": "ä½å±…ä¸­å¿ƒã€å¤§è¦æ¨¡åº—èˆ—ã¯ä¸å¯",
    "ç¬¬äºŒç¨®ä½å±…åœ°åŸŸ": "ç¬¬ä¸€ç¨®ã‚ˆã‚Šåºƒç¯„ã€ãƒ›ãƒ†ãƒ«ãƒ»ã‚«ãƒ©ã‚ªã‚±ç­‰ã‚‚å¯",
    "æº–ä½å±…åœ°åŸŸ": "å¹¹ç·šé“è·¯æ²¿ã„ã®ç”¨é€”æ··åœ¨å¯ã€å•†æ¥­ãƒ»ä½å®…ä½µç”¨å¯",
    "è¿‘éš£å•†æ¥­åœ°åŸŸ": "å°è¦æ¨¡å•†æ¥­ï¼‹ä½å±…å¯ã€é¨’éŸ³è¦åˆ¶ã‚ã‚Š",
    "å•†æ¥­åœ°åŸŸ": "å•†æ¥­ä¸­å¿ƒã€ä½å®…ãƒ»å…±åŒä½å®…å¯ã€é«˜å®¹ç©ç‡ã€é˜²ç«åœ°åŸŸã‚ã‚Š",
    "æº–å·¥æ¥­åœ°åŸŸ": "å·¥å ´ãƒ»ä½å®…ãƒ»å•†æ¥­æ··åœ¨å¯ã€ç’°å¢ƒæ‚ªåŒ–æ–½è¨­ä¸å¯",
    "å·¥æ¥­åœ°åŸŸ": "ä½å®…ã‚‚å»ºç¯‰å¯ã€ç”¨é€”åˆ¶é™ã‚ã‚Šã€è¦æ¨¡ã®å¤§ããªæ–½è¨­å¯",
    "å·¥æ¥­å°‚ç”¨åœ°åŸŸ": "ä½å®…å»ºç¯‰ä¸å¯ã€å·¥å ´å°‚ç”¨ã€é«˜å®¹ç©ç‡",
    "ç”¨é€”åœ°åŸŸå¤–ï¼ˆç™½åœ°ï¼‰": "ç”¨é€”åˆ¶é™ãªã—ï¼ˆéƒ½å¸‚è¨ˆç”»åŒºåŸŸå¤–ï¼‰"
}

zone_structure_rules = {
    "ç¬¬ä¸€ç¨®ä½å±¤ä½å±…å°‚ç”¨åœ°åŸŸ": ["æœ¨é€ ", "RCé€ ï¼ˆé‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ï¼‰"],
    "ç¬¬äºŒç¨®ä½å±¤ä½å±…å°‚ç”¨åœ°åŸŸ": ["æœ¨é€ ", "RCé€ ï¼ˆé‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ï¼‰"],
    "ç¬¬ä¸€ç¨®ä¸­é«˜å±¤ä½å±…å°‚ç”¨åœ°åŸŸ": ["æœ¨é€ ", "RCé€ ï¼ˆé‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ï¼‰", "Sé€ ï¼ˆé‰„éª¨é€ ï¼‰"],
    "ç¬¬äºŒç¨®ä¸­é«˜å±¤ä½å±…å°‚ç”¨åœ°åŸŸ": ["æœ¨é€ ", "RCé€ ï¼ˆé‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ï¼‰", "Sé€ ï¼ˆé‰„éª¨é€ ï¼‰"],
    "ç¬¬ä¸€ç¨®ä½å±…åœ°åŸŸ": ["æœ¨é€ ", "RCé€ ï¼ˆé‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ï¼‰", "Sé€ ï¼ˆé‰„éª¨é€ ï¼‰"],
    "ç¬¬äºŒç¨®ä½å±…åœ°åŸŸ": ["æœ¨é€ ", "RCé€ ï¼ˆé‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ï¼‰", "Sé€ ï¼ˆé‰„éª¨é€ ï¼‰"],
    "æº–ä½å±…åœ°åŸŸ": ["æœ¨é€ ", "RCé€ ï¼ˆé‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ï¼‰", "Sé€ ï¼ˆé‰„éª¨é€ ï¼‰"],
    "è¿‘éš£å•†æ¥­åœ°åŸŸ": ["æœ¨é€ ", "RCé€ ï¼ˆé‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ï¼‰", "Sé€ ï¼ˆé‰„éª¨é€ ï¼‰"],
    "å•†æ¥­åœ°åŸŸ": ["æœ¨é€ ", "RCé€ ï¼ˆé‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ï¼‰", "Sé€ ï¼ˆé‰„éª¨é€ ï¼‰"],
    "æº–å·¥æ¥­åœ°åŸŸ": ["RCé€ ï¼ˆé‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ï¼‰", "Sé€ ï¼ˆé‰„éª¨é€ ï¼‰"],
    "å·¥æ¥­åœ°åŸŸ": ["RCé€ ï¼ˆé‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ï¼‰", "Sé€ ï¼ˆé‰„éª¨é€ ï¼‰"],
    "å·¥æ¥­å°‚ç”¨åœ°åŸŸ": ["RCé€ ï¼ˆé‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ï¼‰", "Sé€ ï¼ˆé‰„éª¨é€ ï¼‰"],
    "ç”¨é€”åœ°åŸŸå¤–ï¼ˆç™½åœ°ï¼‰": ["æœ¨é€ ", "RCé€ ï¼ˆé‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ï¼‰", "Sé€ ï¼ˆé‰„éª¨é€ ï¼‰"]
}

unit_prices = {
    "æœ¨é€ ": 350000,
    "RCé€ ï¼ˆé‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ï¼‰": 500000,
    "Sé€ ï¼ˆé‰„éª¨é€ ï¼‰": 400000
}

# PDFç”Ÿæˆé–¢æ•°
def generate_pdf(proposals, table_df):
    pdf = FPDF()
    pdf.add_page()
    pdf.add_font("IPA", "", "ipaexg.ttf", uni=True)
    pdf.set_font("IPA", size=12)

    pdf.cell(0, 10, "å»ºç¯‰ææ¡ˆæ›¸", ln=True)
    pdf.set_font("IPA", size=10)
    pdf.cell(0, 10, f"ä½œæˆæ—¥ï¼š{datetime.date.today()}", ln=True)
    pdf.ln(10)

    pdf.set_font("IPA", size=11)
    pdf.cell(0, 10, "ã€æ§‹é€ åˆ¥ æ¦‚ç®—è²»ç”¨ æ¯”è¼ƒè¡¨ã€‘", ln=True)
    for i, row in table_df.iterrows():
        pdf.cell(0, 8, f"{row['æ§‹é€ ']}: å»¶åºŠ {row['å»¶åºŠé¢ç©']}ã¡ / å˜ä¾¡ {row['å˜ä¾¡']} å†† â†’ æ¦‚ç®—è²»ç”¨ {row['æ¦‚ç®—è²»ç”¨']:,} å††", ln=True)
    pdf.ln(5)

    for item in proposals:
        pdf.set_font("IPA", size=11)
        pdf.cell(0, 10, f"ã€{item['æ§‹é€ ']} ã®ææ¡ˆã€‘", ln=True)
        pdf.set_font("IPA", size=10)
        for line in item["ææ¡ˆ"].split("\n"):
            pdf.multi_cell(0, 6, line)
        pdf.ln(4)

    return pdf.output(dest="S").encode("latin1")

# Streamlit ã‚¢ãƒ—ãƒªæœ¬ä½“
st.set_page_config(page_title="å»ºç¯‰ææ¡ˆï¼‹æ§‹é€ åˆ¤å®š", layout="centered")
st.title("æ§‹é€ åˆ¥ å»ºç¯‰ææ¡ˆæ›¸ï¼ˆç”¨é€”åœ°åŸŸãƒ»æ§‹é€ åˆ¶é™å¯¾å¿œï¼‰")

with st.form("input_form"):
    st.subheader("ã€æ•·åœ°æ¡ä»¶ã®å…¥åŠ›ã€‘")
    col1, col2 = st.columns(2)
    with col1:
        site_area = st.number_input("æ•·åœ°é¢ç©ï¼ˆã¡ï¼‰", value=150)
        bpr = st.number_input("å»ºãºã„ç‡ï¼ˆ%ï¼‰", value=60)
        road_width = st.number_input("å‰é¢é“è·¯å¹…å“¡ï¼ˆmï¼‰", value=4.0)
    with col2:
        far = st.number_input("å®¹ç©ç‡ï¼ˆ%ï¼‰", value=200)
        usage = st.text_input("å»ºç‰©ç”¨é€”", "ä½å®…")
        fire_zone = st.selectbox("é˜²ç«æŒ‡å®š", ["ãªã—", "æº–é˜²ç«åœ°åŸŸ", "é˜²ç«åœ°åŸŸ"])

    zone = st.selectbox("ç”¨é€”åœ°åŸŸ", list(zone_rules.keys()))
    st.markdown(f"ğŸ§¾ **ç”¨é€”åœ°åŸŸã®æ¦‚è¦**ï¼š{zone_rules[zone]}")

    structures = st.multiselect(
        "æ¯”è¼ƒã™ã‚‹æ§‹é€ ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰",
        ["æœ¨é€ ", "RCé€ ï¼ˆé‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ï¼‰", "Sé€ ï¼ˆé‰„éª¨é€ ï¼‰"],
        default=["æœ¨é€ ", "RCé€ ï¼ˆé‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ ï¼‰"]
    )

    allowed_structures = zone_structure_rules.get(zone, [])
    disallowed = [s for s in structures if s not in allowed_structures]

    if disallowed:
        st.warning(f"âš ï¸ ä»¥ä¸‹ã®æ§‹é€ ã¯ã€Œ{zone}ã€ã§ã¯å»ºç¯‰ãŒåˆ¶é™ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™: {', '.join(disallowed)}")

    submit = st.form_submit_button("â–¶ ææ¡ˆã‚’ç”Ÿæˆ")

if submit:
    filtered_structures = [s for s in structures if s in allowed_structures]
    if not filtered_structures:
        st.error("æœ‰åŠ¹ãªæ§‹é€ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç”¨é€”åœ°åŸŸã¨æ§‹é€ ã®çµ„ã¿åˆã‚ã›ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        st.stop()

    st.info("GPTã«ã‚ˆã‚‹æ§‹é€ åˆ¥ææ¡ˆã‚’ç”Ÿæˆä¸­â€¦")
    proposal_data = []
    selected_rule = zone_rules.get(zone, "ç”¨é€”åœ°åŸŸã®è£œè¶³ã¯æœªå®šç¾©ã§ã™ã€‚")

    for struct in filtered_structures:
        prompt = f"""
ã‚ãªãŸã¯å»ºç¯‰å£«ã§ã™ã€‚
ä»¥ä¸‹ã®æ•·åœ°æ¡ä»¶ã«åŸºã¥ãã€ã€Œ{struct}ã€æ§‹é€ ã§å»ºã¦ã‚‹å ´åˆã®ææ¡ˆã‚’å‡ºã—ã¦ãã ã•ã„ï¼š

- ç”¨é€”åœ°åŸŸï¼š{zone}
- æ•·åœ°é¢ç©ï¼š{site_area}ã¡ã€å»ºãºã„ç‡ï¼š{bpr}%ã€å®¹ç©ç‡ï¼š{far}%
- å‰é¢é“è·¯å¹…å“¡ï¼š{road_width}mã€é˜²ç«æŒ‡å®šï¼š{fire_zone}
- ç”¨é€”ï¼š{usage}

ã€ç”¨é€”åœ°åŸŸã«é–¢ã™ã‚‹è£œè¶³ã€‘
{selected_rule}

ä»¥ä¸‹ã‚’å«ã‚ã¦ãã ã•ã„ï¼š
1. å»ºç¯‰å¯èƒ½éšæ•°
2. å»¶åºŠé¢ç©ï¼ˆæ¦‚ç®—ã€ã¡ï¼‰
3. æ§‹é€ ã®ç‰¹å¾´ãƒ»ç”¨é€”ä¾‹ãƒ»æ³•çš„æ³¨æ„ç‚¹
4. èª¬æ˜æ–‡ç« 
"""

        response = client.chat.completions.create(
            model="gpt-4",
            messages=[
                {"role": "system", "content": "ã‚ãªãŸã¯å»ºç¯‰æ³•è¦ã«è©³ã—ã„ä¸€ç´šå»ºç¯‰å£«ã§ã™ã€‚"},
                {"role": "user", "content": prompt}
            ]
        )

        content = response.choices[0].message.content.strip()
        match = re.search(r"å»¶åºŠé¢ç©.*?([0-9]+)\s*ã¡", content)
        area = int(match.group(1)) if match else int(site_area * far / 100)
        price = unit_prices[struct]
        cost = area * price

        proposal_data.append({
            "æ§‹é€ ": struct,
            "å»¶åºŠé¢ç©": area,
            "å˜ä¾¡": price,
            "æ¦‚ç®—è²»ç”¨": cost,
            "ææ¡ˆ": content
        })

        st.subheader(f"ã€{struct}ã€‘ã®ææ¡ˆ")
        st.markdown(content)
        st.markdown(f"ğŸ“ **å»¶åºŠé¢ç©ï¼ˆæ¨å®šï¼‰**: {area}ã¡")
        st.markdown(f"ğŸ’° **æ¦‚ç®—å»ºè¨­è²»**: {cost:,} å††")
        st.divider()

    df = pd.DataFrame(proposal_data)[["æ§‹é€ ", "å»¶åºŠé¢ç©", "å˜ä¾¡", "æ¦‚ç®—è²»ç”¨"]]
    st.subheader("æ§‹é€ åˆ¥ æ¦‚ç®—è²»ç”¨ æ¯”è¼ƒè¡¨")
    st.table(df)

    pdf_output = generate_pdf(proposal_data, df)

    st.subheader("ğŸ“„ ææ¡ˆæ›¸PDFã‚’å‡ºåŠ›")
    st.download_button(
        label="ææ¡ˆæ›¸ã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
        data=pdf_output,
        file_name="å»ºç¯‰ææ¡ˆæ›¸.pdf",
        mime="application/pdf"
    )
